--[[
MINEABLES CONTENTS: (ClassName = MeshPart)
RubyCrystal - RUBIES
CoinSmall --- SMALL PILE
CoinBox ----- CRATE
CoinChest --- CHEST

DROPPED GUN: (ClassName = Part)
GunMesh
Handle
--]]

local version = "0.5"

local cg = game:GetService("CoreGui")
local sg = game:GetService("StarterGui")
local uis = game:GetService("UserInputService")
local Characters = game.Workspace:FindFirstChild("Characters")
local tempent = game.Workspace:FindFirstChild("Entities")
local entities
local mineables = game.Workspace:FindFirstChild("Mineables")
local orbs = game.Workspace:FindFirstChild("Orbs")

local lplr = game:GetService("Players").LocalPlayer

function notify(title, text)
    sg:SetCore("SendNotification", {
    	Title = tostring(title);
    	Text = tostring(text);
    	Duration = 3;
     })
end

function announce(text)
    game:GetService("ReplicatedStorage").DefaultChatSystemChatEvents.SayMessageRequest:FireServer(text, "All")
end

local settings = {
    textesp = true,
    dotesp = true,
    roleesp = true,
    crateesp = true,
    gunesp = true,
    orbesp = false,
    announceroles = false,
    announcedeaths = false,
    announcegundrop = false,
    notifyroles = true,
    notifydeaths = true,
    notifygundrop = true,
    waitbetweenidentification = .65,
}

if tempent:FindFirstChild("MapModel") then
    tempent.Name = "Entities2"
    entities = game.Workspace:FindFirstChild("Entities")
else
    entities = tempent
end

warn("initialziing")

if cg:FindFirstChild("lhook") then cg["lhook"]:Destroy() end

local library = loadstring(game:HttpGet("https://raw.githubusercontent.com/kotsyaj/lasagnehook/roblox/lhlib.lua"))()

local lasagnehook = library:Window({name = "<font color=\"#AA55EB\">kotsyaj.fun</font> | " .. "TMMX [RELEASE] v" .. version})

local gui = cg:FindFirstChild("lhook")
script.Parent = gui["Frame"]

local ui_settings = {
    toggle_key = Enum.KeyCode.RightShift,
    toggled = true
}

uis.InputBegan:Connect(function(input, gameProcessed)
	if input.KeyCode == (ui_settings.toggle_key  or Enum.KeyCode.RightShift) then
		if gui then
			if ui_settings.toggled then
			    ui_settings.toggled = false
			    gui:FindFirstChildOfClass("Frame").Visible = false
			else
			    ui_settings.toggled = true
			    gui:FindFirstChildOfClass("Frame").Visible = true
			end
		end
	end
end)

local main = lasagnehook:Page({Name = "main"})

local esp_section = main:Section({Name = "ESP", side = "Left"})

local textesptog = esp_section:Toggle({Name = "Text ESP", Default = true, Callback = function(bool)
    settings.textesp = bool
    for _, v in pairs(game:GetDescendants()) do
        if v:IsA("BillboardGui") and v.Name == "textesp" and bool == true then
            v.Enabled = true
        elseif v:IsA("BillboardGui") and v.Name == "textesp" and bool == false then
            v.Enabled = false
        end
    end
end})

local dotesptog = esp_section:Toggle({Name = "Dot ESP", Default = true, Callback = function(bool)
    settings.dotesp = bool
    for _, v in pairs(game:GetDescendants()) do
        if v:IsA("BillboardGui") and v.Name == "dotesp" and bool == true then
            v.Enabled = true
        elseif v:IsA("BillboardGui") and v.Name == "dotesp" and bool == false then
            v.Enabled = false
        end
    end
end})

local roleesptog = esp_section:Toggle({Name = "Role ESP", Default = true, Callback = function(bool)
    settings.roleesp = bool
    for _, v in pairs(Characters:GetDescendants()) do
        if v.Name == "cham" and bool == true then
            v.Transparency = 0.5
        elseif v.Name == "cham" and bool == false then
            v.Transparency = 1
        end
    end
end})

local crateesptog = esp_section:Toggle({Name = "Crate ESP", Default = true, Callback = function(bool)
    settings.crateesp = bool
    for _, v in pairs(mineables:GetDescendants()) do
        if v.Name == "cham" and bool == true then
            v.Transparency = 0.5
        elseif v.Name == "cham" and bool == false then
            v.Transparency = 1
        end
    end
end})

local gunesptog = esp_section:Toggle({Name = "Gun ESP", Default = true, Callback = function(bool)
    settings.gunesp = bool
    for _, v in pairs(entities:GetDescendants()) do
        if v.Name == "cham" and bool == true then
            v.Transparency = 0.5
        elseif v.Name == "cham" and bool == false then
            v.Transparency = 1
        end
    end
end})

local orbesptog = esp_section:Toggle({Name = "Orb ESP", Default = false, Callback = function(bool)
    settings.orbesp = bool
end})

local misc_section = main:Section({Name = "Misc", side = "Right"})

local announcerolestog = misc_section:Toggle({Name = "Say Roles", Default = false, Callback = function(bool)
    settings.announceroles = bool
end})

local announcedeathstog = misc_section:Toggle({Name = "Say Deaths", Default = false, Callback = function(bool)
    settings.announcedeaths = bool
end})

local announceguntog = misc_section:Toggle({Name = "Say Gun Drop", Default = false, Callback = function(bool)
    settings.announcegundrop = bool
end})

local rolenotifytog = misc_section:Toggle({Name = "Notify Roles", Default = true, Callback = function(bool)
    settings.notifyroles = bool
end})

local deathnotifytog = misc_section:Toggle({Name = "Notify Deaths", Default = true, Callback = function(bool)
    settings.notifydeaths = bool
end})

local gunnotifytog = misc_section:Toggle({Name = "Notify Gun Drop", Default = true, Callback = function(bool)
    settings.notifygundrop = bool
end})

warn("done!")

local function createBoxHandleAdornment(part, color)
    local cham = Instance.new("BoxHandleAdornment")
    cham.Name = "cham"	
    if color == "white" then cham.Color3 = Color3.new(100 / 255, 100 / 255, 100 / 255) elseif color == "red" then cham.Color3 = Color3.new(100 / 255, 0, 0) elseif color == "green" then cham.Color3 = Color3.new(0, 100 / 255, 0) elseif color == "blue" then cham.Color3 = Color3.new(0, 0, 100 / 255) end
    cham.Transparency = 0.5
    cham.ZIndex = 0
    cham.AlwaysOnTop = true
    cham.Visible = true
    cham.Size = part.Size
    cham.Adornee = part
    cham.Parent = part
end

local function createTextESP(part, text, color)
    local esp = Instance.new("BillboardGui")
    local esp_2 = Instance.new("TextLabel")

    esp.Name = "textesp"
    esp.Parent = part
    esp.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    esp.Active = true
    esp.AlwaysOnTop = true
    esp.LightInfluence = 1
    esp.Size = UDim2.new(9, 0, 1, 0)
    esp.StudsOffset = Vector3.new(0, 1.25, 0)
    
    esp_2.Name = "textesp"
    esp_2.Parent = esp
    esp_2.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    esp_2.BackgroundTransparency = 1.000
    esp_2.Size = UDim2.new(1, 0, 1, 0)
    esp_2.Font = Enum.Font.Code
    esp_2.Text = text
    esp_2.TextColor3 = Color3.fromHex(color)
    esp_2.TextSize = 12
    esp_2.TextStrokeTransparency = 0.000
    esp_2.TextWrapped = true
end

local function createDotESP(part, color)
    local dotesp = Instance.new("BillboardGui", part)
    local dotesp_2 = Instance.new("Frame")
    
    dotesp.Name = "dotesp"
    dotesp.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    dotesp.Active = true
    dotesp.AlwaysOnTop = true
    dotesp.Size = UDim2.new(0, 2, 0, 2)
    
    dotesp_2.Name = "dotesp"
    dotesp_2.Parent = dotesp
    dotesp_2.BackgroundColor3 = Color3.fromHex(color)
    dotesp_2.BorderColor3 = Color3.fromRGB(0, 0, 0)
    dotesp_2.Size = UDim2.new(1, 0, 1, 0)
end

local mwaiting = false
local swaiting = false

local function announcedebouncesheriff(text)
    if mwaiting ~= true then
        mwaiting = true
        announce(text)
        print("waiting")
        wait(60)
        print("done")
        mwaiting = false
    end
end

local function announcedebouncemurderer(text)
    if swaiting ~= true then
        swaiting = true
        announce(text)
        print("waiting")
        wait(60)
        print("done")
        swaiting = false
    end
end

-- Main init
for _, cfplrinit in pairs(Characters:GetChildren()) do
    if settings.dotesp == true and cfplrinit ~= lplr.Character then createDotESP(cfplrinit:WaitForChild("Head"), "#ffffff") end
    cfplrinit.ChildAdded:connect(function(v)
        if v.Name == "WorldModel" and v:FindFirstChild("Knife") and cfplrinit:FindFirstChild("Humanoid") then
            if not cfplrinit.Head:FindFirstChild("cham") and cfplrinit ~= lplr.Character then
                wait(settings.waitbetweenidentification)
                if cfplrinit:FindFirstChild("Humanoid") and cfplrinit:FindFirstChild("Humanoid").Health > 0 then
                    if settings.notifyroles == true then notify("Roles Notif", cfplrinit.Name .. " is murderer") end
                    if settings.roleesp == true then
                        createBoxHandleAdornment(cfplrinit.Head, "red")
                    end
                    if settings.textesp == true then
                        createTextESP(cfplrinit.Head, "murderer", "#ff0000")
                    end
                    if settings.announceroles == true then announcedebouncemurderer(cfplrinit.Name .. " is murderer") end
                else
                    if settings.notifydeaths == true then notify("Death Notif", cfplrinit.Name .. " has died") end
                    if settings.announcedeaths == true then announce(cfplrinit.Name .. " died to a mysterious flying object (owned!)") end
                end
            end
        elseif v.Name == "WorldModel" and v:FindFirstChild("Gun") and cfplrinit:FindFirstChild("Humanoid") then
            if not cfplrinit.Head:FindFirstChild("cham") and cfplrinit ~= lplr.Character then
                if settings.notifyroles == true then notify("Roles Notif", cfplrinit.Name .. " is sheriff") end
                if settings.roleesp == true then
                    createBoxHandleAdornment(cfplrinit.Head, "green")
                end
                if settings.textesp == true then
                    createTextESP(cfplrinit.Head, "sheriff", "#00ff00")
                end
                if settings.announceroles == true then announcedebouncesheriff(cfplrinit.Name .. " has the gun") end
            end
        end
    end)
end
-- Main init

wait(1)

-- Loop
--pcall(function()
    Characters.ChildAdded:connect(function(cfplr)
        if settings.dotesp == true and cfplr ~= lplr.Character then createDotESP(cfplr:WaitForChild("Head"), "#ffffff") end
        cfplr.ChildAdded:connect(function(v)
            if v.Name == "WorldModel" and v:FindFirstChild("Knife") and cfplr:FindFirstChild("Humanoid") then
                if not cfplr.Head:FindFirstChild("cham") and cfplr ~= lplr.Character then
                    wait(settings.waitbetweenidentification)
                    if cfplr:FindFirstChild("Humanoid") and cfplr:FindFirstChild("Humanoid").Health > 0 then
                        if settings.notifyroles == true then notify("Roles Notif", cfplr.Name .. " is murderer") end
                        if settings.announceroles == true then announcedebouncemurderer(cfplr.Name .. " is murderer") end
                        if settings.roleesp == true then
                            createBoxHandleAdornment(cfplr.Head, "red")
                        end
                        if settings.textesp == true then
                            createTextESP(cfplr.Head, "murderer", "#ff0000")
                        end
                    else
                        if settings.notifydeaths == true then notify("Death Notif", cfplr.Name .. " has died from throwing knife") end
                        if settings.announcedeaths == true then announce(cfplr.Name .. " died to a mysterious flying object (owned!)") end
                    end
                end
            elseif v.Name == "WorldModel" and v:FindFirstChild("Gun") and cfplr:FindFirstChild("Humanoid") then
                if not cfplr.Head:FindFirstChild("cham") and cfplr ~= lplr.Character then
                    if settings.notifyroles == true then notify("Roles Notif", cfplr.Name .. " is sheriff") end
                    if settings.roleesp == true then
                        createBoxHandleAdornment(cfplr.Head, "green")
                    end
                    if settings.textesp == true then
                        createTextESP(cfplr.Head, "sheriff", "#00ff00")
                    end
                    if settings.announceroles == true then announcedebouncesheriff(cfplr.Name .. " has the gun") end
                end
            end
        end)
    end)
--end)
-- Loop

-- Orb ESP
--[[pcall(function()
    orbs.ChildAdded:connect(function(orb)
        if settings.orbesp == true then
            if orb:IsA("BillboardGui") then
                v.AlwaysOnTop = true
            end
        end
    end)
end)]]
-- Orb ESP

-- Crate/Chest ESP
pcall(function()
	mineables.ChildAdded:Connect(function(mineable)
        if settings.crateesp == true and mineable.Name == "CoinBox" then
	        createBoxHandleAdornment(mineable:FindFirstChildOfClass("MeshPart"), "white")
        elseif settings.crateesp == true and mineable.Name == "CoinChest" then
            createBoxHandleAdornment(mineable:FindFirstChildOfClass("MeshPart"), "white")
        end
       --[[ if settings.textesp == true and mineable.Name == "CoinChest" then
            createTextESP(mineable:FindFirstChildOfClass("MeshPart"), "chest", "#ffffff")
        elseif settings.textesp == true and mineable.Name == "CoinBox" then
            createTextESP(mineable:FindFirstChildOfClass("MeshPart"), "crate", "#ffffff")
        end]]
        if settings.textesp == true then
            createTextESP(mineable:FindFirstChildOfClass("MeshPart"), string.lower(mineable.Name), "#ffffff")
        end
    end)
end)
-- Crate/Chest ESP

-- Gun ESP
pcall(function()
	entities.ChildAdded:Connect(function(gun)
        if settings.notifygundrop == true then notify("Gun Notif", "Gun has been dropped") end
        if settings.announcegundrop == true then announce("gun dropped") end
        if settings.gunesp == true then
	        createBoxHandleAdornment(gun:WaitForChild("Handle"), "blue")
        end
        if settings.textesp == true then
            createTextESP(gun:WaitForChild("Handle"), "gun", "#0000ff")
        end
    end)
end)
-- Gun ESP

print(":::    ::: :::::::: ::::::::::: ::::::::  :::   :::   :::     :::::::::::")
print(":+:   :+: :+:    :+:    :+:    :+:    :+: :+:   :+: :+: :+:       :+:    ")
print("+:+  +:+  +:+    +:+    +:+    +:+         +:+ +:+ +:+   +:+      +:+    ")
print("+#++:++   +#+    +:+    +#+    +#++:++#++   +#++: +#++:++#++:     +#+    ")
print("+#+  +#+  +#+    +#+    +#+           +#+    +#+  +#+     +#+     +#+    ")
print("#+#   #+# #+#    #+#    #+#    #+#    #+#    #+#  #+#     #+# #+# #+#    ")
print("###    ### ########     ###     ########     ###  ###     ###  #####     ")
